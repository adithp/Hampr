{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Return Request | HAMPR</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'accounts/css/style.css' %}">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            border-radius: 16px;
            overflow: hidden;
        }

        .form-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .form-control,
        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #D4AF37;
            /* Gold color */
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.15);
        }

        .upload-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #fff;
            position: relative;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #D4AF37;
            background-color: #fffcf5;
        }

        .upload-zone i {
            font-size: 2.5rem;
            color: #adb5bd;
            margin-bottom: 1rem;
            transition: color 0.3s ease;
        }

        .upload-zone:hover i {
            color: #D4AF37;
        }

        .upload-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
            background: #fff;
            border: 1px solid #eee;
        }

        .preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .preview-item img,
        .preview-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #dc3545;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            opacity: 0;
        }

        .preview-item:hover .remove-btn {
            opacity: 1;
        }

        .preview-item .remove-btn:hover {
            background: #dc3545;
            color: #fff;
        }

        .preview-item .file-type-icon {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            pointer-events: none;
        }

        .btn-gold {
            background-color: #D4AF37;
            color: #fff;
            border: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .btn-gold:hover {
            background-color: #c5a028;
            color: #fff;
            transform: translateY(-1px);
        }

        /* Animation classes */
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <style>
        .popup-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: #fff;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const popup = document.getElementById("successPopup");
            if (popup) {
                setTimeout(() => {
                    popup.style.opacity = "0";
                    setTimeout(() => popup.remove(), 300);
                }, 3000); // 3 seconds
            }
        });
    </script>

</head>

<body>
    <!-- Header -->
    {% include 'catalog/nav-bar.html' %}

    <section class="py-5" style="margin-top: 80px;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-7 col-xl-6">
                    <div class="card border-0 shadow-lg fade-in-up">
                        <div class="card-body p-4 p-md-5">
                            <div class="text-center mb-5">
                                <h2 class="fw-bold mb-2" style="font-family: 'Playfair Display', serif;">Request a
                                    Return</h2>
                                <p class="text-muted">We're sorry the item didn't work out. Let's get this sorted.</p>
                            </div>

                            <form id="returnForm" method="POST" enctype="multipart/form-data">
                                {% if messages %}
                                {% for message in messages %}
                                {% if message.tags == 'success' %}
                                <div class="popup-message success" id="successPopup">
                                    {{ message }}
                                </div>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {% for error in form.non_field_errors %}
                                    <p class="mb-0">{{ error }}</p>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                {% csrf_token %}

                                <!-- Reason for Return -->
                                <div class="mb-4">
                                    <label for="returnReason" class="form-label">Reason for Return</label>
                                    <select class="form-select" id="returnReason" name="reason" required>
                                        <option value="" selected disabled>Select a reason...</option>
                                        <option value="defective">Defective or Damaged Product</option>
                                        <option value="wrong_item">Received Wrong Item</option>
                                        <option value="not_as_described">Product Not as Described</option>
                                        <option value="quality_issue">Quality Issue</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                {{form.reason.errors}}

                                <!-- Description -->
                                <div class="mb-4">
                                    <label for="returnDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="returnDescription" name="description" rows="4"
                                        placeholder="Please provide more details about the issue..."
                                        required>{{ form.description.value|default_if_none:"" }}</textarea>
                                    {{form.description.errors}}
                                </div>

                                <!-- Media Upload -->
                                <div class="mb-5">
                                    <label class="form-label d-block">Upload Evidence <small
                                            class="text-muted fw-normal ms-1">(Max 10 files)</small></label>

                                    <div class="upload-zone" id="dropZone">
                                        <!-- Hidden inputs for form submission -->

                                        <input type="file" id="imagesInput" name="images" accept="image/*" multiple
                                            hidden>
                                        <input type="file" id="videosInput" name="videos" accept="video/*" multiple
                                            hidden>

                                        <!-- Dummy input for triggering file dialog -->
                                        <input type="file" id="mediaTrigger" accept="image/*,video/*" multiple hidden>

                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <h6 class="fw-bold mb-1">Click or Drag & Drop to Upload</h6>
                                        <p class="text-muted small mb-0">Support JPG, PNG, MP4 (Max 150MB per video)</p>
                                    </div>

                                    <div id="uploadPreview" class="upload-preview-container"></div>
                                    <div id="fileError" class="text-danger small mt-2 d-none"><i
                                            class="fas fa-exclamation-circle me-1"></i> <span id="errorMsg"></span>
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-gold btn-lg rounded-pill py-3 shadow-sm">Submit
                                        Return Request</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dropZone = document.getElementById('dropZone');
            const mediaTrigger = document.getElementById('mediaTrigger');
            const imagesInput = document.getElementById('imagesInput');
            const videosInput = document.getElementById('videosInput');
            const uploadPreview = document.getElementById('uploadPreview');
            const fileError = document.getElementById('fileError');
            const errorMsg = document.getElementById('errorMsg');

            const maxFiles = 10;
            const maxVideoSize = 150 * 1024 * 1024; // 150MB in bytes
            let selectedFiles = [];

            // Trigger file input on click
            dropZone.addEventListener('click', () => mediaTrigger.click());

            // Drag and Drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropZone.classList.add('dragover');
            }

            function unhighlight(e) {
                dropZone.classList.remove('dragover');
            }

            dropZone.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }

            mediaTrigger.addEventListener('change', function (e) {
                handleFiles(this.files);
                // Reset trigger so same files can be selected again if needed
                this.value = '';
            });

            function showError(msg) {
                errorMsg.textContent = msg;
                fileError.classList.remove('d-none');
            }

            function hideError() {
                fileError.classList.add('d-none');
            }

            function handleFiles(files) {
                const newFiles = Array.from(files);
                hideError();

                if (selectedFiles.length + newFiles.length > maxFiles) {
                    showError(`You can only upload a maximum of ${maxFiles} files.`);
                    return;
                }

                for (const file of newFiles) {
                    // Check for duplicates
                    if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) continue;

                    // Validate Video Size
                    if (file.type.startsWith('video/')) {
                        if (file.size > maxVideoSize) {
                            showError(`Video "${file.name}" exceeds the 150MB size limit.`);
                            return; // Stop processing this batch
                        }
                    }

                    selectedFiles.push(file);
                    previewFile(file);
                }

                updateHiddenInputs();
            }

            function previewFile(file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = function () {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item fade-in-up';
                    previewItem.style.animationDelay = '0s';
                    previewItem.style.animationDuration = '0.4s';

                    let content;
                    let typeIcon;

                    if (file.type.startsWith('image/')) {
                        content = `<img src="${reader.result}" alt="Preview">`;
                        typeIcon = '<i class="fas fa-image"></i>';
                    } else if (file.type.startsWith('video/')) {
                        content = `<video src="${reader.result}"></video>`;
                        typeIcon = '<i class="fas fa-video"></i>';
                    } else {
                        content = `<div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted"><i class="fas fa-file fa-2x"></i></div>`;
                        typeIcon = '<i class="fas fa-file"></i>';
                    }

                    previewItem.innerHTML = `
                        ${content}
                        <div class="file-type-icon">${typeIcon}</div>
                        <button type="button" class="remove-btn" onclick="removeFile('${file.name}')" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    uploadPreview.appendChild(previewItem);
                }
            }

            window.removeFile = function (fileName) {
                selectedFiles = selectedFiles.filter(f => f.name !== fileName);
                renderPreview();
                updateHiddenInputs();
                hideError();
            };

            function renderPreview() {
                uploadPreview.innerHTML = '';
                selectedFiles.forEach(file => previewFile(file));
            }

            function updateHiddenInputs() {
                const dtImages = new DataTransfer();
                const dtVideos = new DataTransfer();

                selectedFiles.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        dtImages.items.add(file);
                    } else if (file.type.startsWith('video/')) {
                        dtVideos.items.add(file);
                    }
                });

                imagesInput.files = dtImages.files;
                videosInput.files = dtVideos.files;
            }
        });
    </script>
</body>

</html>