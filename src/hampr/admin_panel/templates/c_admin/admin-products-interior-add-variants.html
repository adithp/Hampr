{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Interior Product - Variants | Admin Dashboard</title>

    <!-- Fonts / CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Cropper -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Outfit', sans-serif;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            padding-top: 48px;
            background: #fff;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .06);
        }

        .main-content {
            margin-left: 240px;
            padding: 2rem;
            transition: all .3s;
        }

        .form-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .05);
        }

        .img-container {
            max-height: 500px;
        }

        .img-container img {
            max-width: 100%;
            display: block;
        }

        .variant-thumb {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
            border-radius: 6px;
        }

        .variant-img-wrapper {
            width: 100px;
            position: relative;
            margin-bottom: 6px;
            margin-right: 8px;
        }

        .primary-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 123, 255, .9);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .order-input-container {
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: center;
            padding-top: 6px;
            margin-top: 6px;
        }

        .variant-thumbnails {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .variant-img-upload-box {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100px;
            height: 100px;
        }

        .variant-card .remove-variant-btn {
            position: absolute;
            right: 16px;
            top: 16px;
        }

        @media (max-width:768px) {
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .mobile-nav-toggle {
                display: block;
            }
        }
    </style>
</head>

<body>

    <button class="mobile-nav-toggle btn btn-light" onclick="toggleSidebar()"
        style="display:none; position:fixed; z-index:101; top:12px; left:12px;">
        <i class="fas fa-bars"></i>
    </button>

    <nav class="sidebar" id="sidebar">
        <div class="px-4 mb-4">
            <h3 class="fw-bold">HAM<span style="color:#d4af37">PR.</span></h3>
            <p class="text-muted small">Admin Portal</p>
        </div>
        <div class="px-3">
            <form action="{% url 'cadmin:cancel_add_product' %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-times me-2"></i>Cancel & Exit
                </button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a style="text-decoration: none;" class="text-muted">Products</a></li>
                    <li class="breadcrumb-item"><a style="text-decoration: none;" class="text-muted">Interior Items</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Add Variants</li>
                </ol>
            </nav>
        </div>

        <h2 class="fw-bold">Add New Interior Product</h2>
        <p class="text-muted mb-4">Step 2: Inventory, Variants & Images</p>

        <div class="card form-card p-4">
            {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form id="productForm" action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                {% if form.non_field_errors or color_form.non_field_errors or size_form.non_field_errors %}
                <div class="alert alert-danger">
                    <strong>There were some errors:</strong>
                    <ul class="mb-0">
                        {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                        {% for error in color_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                        {% for error in size_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- SINGLE VARIANT BLOCK (only one at a time) -->
                <!-- We use explicit names matching your backend checks (variant-1 in names) -->
                <div id="variant-1" class="variant-card card mb-3 p-3 position-relative">
                    <div class="row g-3">

                        <!-- Type select: user chooses, we do NOT auto-select on server -->
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Type</label>
                            <select name="variant_type_variant-1" class="form-select variant-type-select"
                                onchange="updateVariantInput(this,'variant-1')">
                                <option value="Color">Color</option>
                                <option value="Size">Size</option>
                            </select>
                            {% if form.variant_type.errors %}
                            <div class="text-danger small">{{ form.variant_type.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Value container (default shows Color inputs, JS will switch to Size if selected) -->
                        <div class="col-md-4" id="variant-value-container-variant-1">
                            <label class="form-label small text-muted">Color Name & Code</label>
                            <div class="input-group">
                                <span class="input-group-text p-1">
                                    <input name="variant_color_code_variant-1" type="color"
                                        class="form-control form-control-color border-0"
                                        value="{{ color_form.initial.hex|default:'#000000' }}">
                                </span>
                                <input name="variant_color_variant-1" type="text" class="form-control"
                                    placeholder="e.g. Red" value="{{ color_form.initial.name|default:'' }}">
                            </div>
                            {% if color_form.name.errors %}
                            <div class="text-danger small">{{ color_form.name.errors }}</div>
                            {% endif %}
                            {% if color_form.hex.errors %}
                            <div class="text-danger small">{{ color_form.hex.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Cost -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Cost Price (₹)</label>
                            <input name="cost" value="{{ form.cost.value|default:'' }}" type="number"
                                class="form-control">
                            {% if form.cost.errors %}
                            <div class="text-danger small">{{ form.cost.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Selling Price -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Selling Price (₹)</label>
                            <input name="price" type="number" value="{{ form.price.value|default:'' }}"
                                class="form-control">
                            {% if form.price.errors %}
                            <div class="text-danger small">{{ form.price.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Stock -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Stock</label>
                            <input name="stock" type="number" value="{{ form.stock.value|default:'' }}"
                                class="form-control">
                            {% if form.stock.errors %}
                            <div class="text-danger small">{{ form.stock.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Dimensions -->
                        <div class="col-12">
                            <label class="form-label small text-muted">Dimensions (cm)</label>
                            <div class="input-group">
                                <span class="input-group-text">H</span>
                                <input name="height" type="number" value="{{ form.height.value|default:'' }}"
                                    class="form-control">

                                <span class="input-group-text">W</span>
                                <input name="width" type="number" value="{{ form.width.value|default:'' }}"
                                    class="form-control">

                                <span class="input-group-text">D</span>
                                <input name="depth" type="number" value="{{ form.depth.value|default:'' }}"
                                    class="form-control">
                            </div>
                            {% if form.height.errors %}
                            <div class="text-danger small">{{ form.height.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Images -->
                        <div class="col-12">
                            <label class="form-label small text-muted">Variant Images</label>
                            <div class="d-flex gap-3 flex-wrap p-3 bg-light rounded">
                                <div class="variant-thumbnails" id="thumbs-variant-1"></div>

                                <label class="variant-img-upload-box btn btn-outline-secondary border-dashed">
                                    <!-- single file input; JS will allow adding multiple images via crop -->
                                    <input type="file" accept="image/*" hidden id="img-input-variant-1"
                                        class="img-input">
                                    <i class="fas fa-plus mb-1"></i>
                                    <small>Add</small>
                                </label>
                            </div>
                            <div class="form-text small">You can add up to {{ max_images|default:"10" }} images per
                                variant.
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-12 mt-4 d-flex justify-content-between">
                    <div>
                        <!-- We only allow one variant at a time (Save to add another) -->
                        <button type="submit" class="btn btn-success px-4">Save Variant</button>
                        <a class="btn btn-secondary" href="{% url 'cadmin:varients_finshed' %}">Finish</a>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="cropImage" src="" alt="Image to crop">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" id="cropCancelBtn">Cancel</button>
                    <button class="btn btn-primary" id="cropBtn">Crop & Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        /* --------------------
         PAGE STATE
        -------------------- */
        let cropper = null;
        let currentCropInput = null;
        let currentVariantKey = 'variant-1';
        let variantImages = {}; // variant-1 => [{id,file,src,order,isThumbnail}, ...]
        const maxImages = Number("{{ max_images|default:"10" }}");

        const cropModalEl = document.getElementById("cropModal");
        const cropModal = new bootstrap.Modal(cropModalEl);
        const cropImage = document.getElementById("cropImage");

        document.addEventListener("DOMContentLoaded", () => {
            // initialize array
            variantImages[currentVariantKey] = [];

            // wire up the single file input
            const input = document.getElementById('img-input-variant-1');
            if (input) input.addEventListener('change', (ev) => initCrop(input, currentVariantKey));

            // cleanup cropper when modal closes
            cropModalEl.addEventListener('hidden.bs.modal', () => {
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                cropImage.src = '';
            });
        });

        /* --------------------
         TYPE switch: color <-> size
        -------------------- */
        function updateVariantInput(selectEl, variantKey) {
            const container = document.getElementById(`variant-value-container-${variantKey}`);
            if (!container) return;

            if (selectEl.value === 'Color') {
                container.innerHTML = `
                    <label class="form-label small text-muted">Color Name & Code</label>
                    <div class="input-group">
                        <span class="input-group-text p-1">
                            <input name="variant_color_code_${variantKey}" type="color" class="form-control form-control-color border-0" value="#000000">
                        </span>
                        <input name="variant_color_${variantKey}" type="text" class="form-control" placeholder="e.g. Red">
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <label class="form-label small text-muted">Value</label>
                    <input type="text" name="size" class="form-control" placeholder="Small">
                    <label class="form-label small text-muted mt-3">Sort Order</label>
                    <input type="text" name="sort_order" class="form-control" placeholder="1">
                `;
            }
        }

        /* --------------------
         IMAGE CROP + PREVIEW
        -------------------- */
        function initCrop(inputEl, variantKey) {
            if (!inputEl.files || !inputEl.files[0]) return;
            const file = inputEl.files[0];

            // basic image check
            if (!file.type.startsWith('image/')) {
                alert('Only image files are allowed.');
                inputEl.value = '';
                return;
            }

            // limit
            if (variantImages[variantKey].length >= maxImages) {
                alert(`Maximum ${maxImages} images allowed for this variant.`);
                inputEl.value = '';
                return;
            }

            currentCropInput = inputEl;
            const reader = new FileReader();
            reader.onload = e => {
                cropImage.src = e.target.result;
                cropModal.show();

                cropModalEl.addEventListener("shown.bs.modal", () => {
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                    });
                }, { once: true });
            };
            reader.readAsDataURL(file);
            inputEl.value = '';
        }

        document.getElementById("cropBtn").addEventListener('click', () => {
            if (!cropper) return;
            cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => {
                const id = Date.now() + Math.floor(Math.random() * 1000);
                const file = new File([blob], `image_${id}.jpg`, { type: 'image/jpeg' });
                const src = URL.createObjectURL(file);

                const arr = variantImages[currentVariantKey] || [];
                arr.push({
                    id, file, src,
                    order: arr.length + 1,
                    isThumbnail: arr.length === 0
                });
                variantImages[currentVariantKey] = arr;

                refreshVariantPreview(currentVariantKey);

                cropModal.hide();
                if (cropper) { cropper.destroy(); cropper = null; }
                cropImage.src = '';
            });
        });

        document.getElementById('cropCancelBtn').addEventListener('click', () => {
            if (cropper) { cropper.destroy(); cropper = null; }
            cropImage.src = '';
        });

        function refreshVariantPreview(variantKey) {
            const thumbsId = `thumbs-${variantKey}`;
            const container = document.getElementById(thumbsId);
            if (!container) return;
            container.innerHTML = '';

            const arr = variantImages[variantKey] || [];
            arr.forEach(img => {
                const wrap = document.createElement('div');
                wrap.className = 'variant-img-wrapper';
                wrap.innerHTML = `
                    ${img.isThumbnail ? `<div class="primary-badge">Primary</div>` : ''}
                    <img src="${img.src}" class="variant-thumb border rounded mb-1" />
                    <div class="d-flex gap-1 justify-content-center">
                        <button type="button" class="btn btn-sm btn-light" onclick="setPrimary('${variantKey}', ${img.id})"><i class="fas fa-image"></i></button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteImg('${variantKey}', ${img.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(wrap);
            });
        }

        function setPrimary(variantKey, imgId) {
            const arr = variantImages[variantKey] || [];
            arr.forEach(i => i.isThumbnail = (i.id === imgId));
            refreshVariantPreview(variantKey);
        }

        function deleteImg(variantKey, imgId) {
            const arr = variantImages[variantKey] || [];
            const remaining = arr.filter(i => i.id !== imgId);
            const removed = arr.find(i => i.id === imgId);
            if (removed && removed.src) URL.revokeObjectURL(removed.src);

            if (remaining.length && !remaining.some(i => i.isThumbnail)) remaining[0].isThumbnail = true;
            variantImages[variantKey] = remaining;
            refreshVariantPreview(variantKey);
        }

        /* --------------------
         FORM SUBMIT: attach files as input elements named exactly as backend expects
            backend expects: images (list), orders (list), primary (list)
        -------------------- */
        document.getElementById("productForm").addEventListener("submit", function (ev) {
            // remove previously added dynamic inputs
            this.querySelectorAll(".dynamic-image-input").forEach(n => n.remove());

            const arr = variantImages[currentVariantKey] || [];
            arr.forEach((img, index) => {
                const dt = new DataTransfer();
                dt.items.add(img.file);

                // backend expects plain 'images' field (as you used in updating_data)
                const f = document.createElement('input');
                f.type = 'file';
                f.name = 'images';
                f.files = dt.files;
                f.className = 'dynamic-image-input d-none';

                const order = document.createElement('input');
                order.type = 'hidden';
                order.name = 'orders';
                order.value = index + 1;
                order.className = 'dynamic-image-input';

                const primary = document.createElement('input');
                primary.type = 'hidden';
                primary.name = 'primary';
                primary.value = img.isThumbnail ? '1' : '0';
                primary.className = 'dynamic-image-input';

                this.appendChild(f);
                this.appendChild(order);
                this.appendChild(primary);
            });

            // allow normal submit to continue
        });

        // small helper
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            if (!sb) return;
            if (sb.style.transform === 'translateX(-100%)') sb.style.transform = '';
            else sb.style.transform = 'translateX(-100%)';
        }
    </script>
</body>

</html>