{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Interior Product - Variants | Admin Dashboard</title>

    <!-- Fonts / CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Cropper -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Outfit', sans-serif;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            padding-top: 48px;
            background: #fff;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .06);
        }

        .main-content {
            margin-left: 240px;
            padding: 2rem;
            transition: all .3s;
        }

        .form-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .05);
        }

        .img-container {
            max-height: 500px;
        }

        .img-container img {
            max-width: 100%;
            display: block;
        }

        .variant-thumb {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
            border-radius: 6px;
        }

        .variant-img-wrapper {
            width: 100px;
            position: relative;
            margin-bottom: 6px;
            margin-right: 8px;
        }

        .primary-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 123, 255, .9);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .order-input-container {
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: center;
            padding-top: 6px;
            margin-top: 6px;
        }

        .variant-thumbnails {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .variant-img-upload-box {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100px;
            height: 100px;
        }

        .variant-card .remove-variant-btn {
            position: absolute;
            right: 16px;
            top: 16px;
        }

        @media (max-width:768px) {
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .mobile-nav-toggle {
                display: block;
            }
        }
    </style>
</head>

<body>

    <button class="mobile-nav-toggle btn btn-light" onclick="toggleSidebar()"
        style="display:none; position:fixed; z-index:101; top:12px; left:12px;">
        <i class="fas fa-bars"></i>
    </button>

    <nav class="sidebar" id="sidebar">
        <div class="px-4 mb-4">
            <h3 class="fw-bold">HAM<span style="color:#d4af37">PR.</span></h3>
            <p class="text-muted small">Admin Portal</p>
        </div>
        <div class="px-3">
            <form action="{% url 'cadmin:interior_product_manage' %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-times me-2"></i>Cancel & Exit
                </button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a style="text-decoration: none;" class="text-muted">Products</a></li>
                    <li class="breadcrumb-item"><a style="text-decoration: none;" class="text-muted">Interior Items</a>
                    </li>
                   
                    
                    <li class="breadcrumb-item active" aria-current="page"> {% if edit %}Edit{% else %}Add{% endif %} Variants</li>
                    
                </ol>
            </nav>
        </div>

        <h2 class="fw-bold">{% if edit %}Edit{% else %}Add New{%  endif %} Interior Product</h2>
        <p class="text-muted mb-4">Step 2: Inventory, Variants & Images</p>

        <div class="card form-card p-4">
            {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form id="productForm" action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                {% if form.non_field_errors or color_form.non_field_errors or size_form.non_field_errors %}
                <div class="alert alert-danger">
                    <strong>There were some errors:</strong>
                    <ul class="mb-0">
                        {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                        {% for error in color_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                        {% for error in size_form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                </div>
                {% endif %}

                <!-- SINGLE VARIANT BLOCK (only one at a time) -->
                <!-- We use explicit names matching your backend checks (variant-1 in names) -->
                <div id="variant-1" class="variant-card card mb-3 p-3 position-relative">
                    <div class="row g-3">

                        <!-- Type select: user chooses, we do NOT auto-select on server -->
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Type</label>
                            <select name="variant_type_variant-1"
        class="form-select variant-type-select"
        id="variantTypeSelect"
        onchange="updateVariantInput(this,'variant-1')">

    <option value="Color"
        {% if form.instance.color %}selected{% endif %}>
        Color
    </option>

    <option value="Size"
        {% if form.instance.size %}selected{% endif %}>
        Size
    </option>
</select>
                            {% if form.variant_type.errors %}
                            <div class="text-danger small">{{ form.variant_type.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Value container (default shows Color inputs, JS will switch to Size if selected) -->
                        <div class="col-md-4"
     id="variant-value-container-variant-1"
    data-size-label="{{ size_form.instance.name|default:'' }}"

     data-size-order="{{ size_form.instance.sort_order|default:'' }}"
     data-color-name="{{ color_form.instance.name|default:'' }}"
     data-color-hex="{{ color_form.instance.hex|default:'#000000' }}">
                            <label class="form-label small text-muted">Color Name & Code</label>
                            <div class="input-group">
                                <span class="input-group-text p-1">
                                    <input name="variant_color_code_variant-1" type="color"
                                        class="form-control form-control-color border-0"
                                        value="{{ color_form.initial.hex|default:'#000000' }}">
                                </span>
                                <input name="variant_color_variant-1" type="text" class="form-control"
                                    placeholder="e.g. Red" value="{{ color_form.initial.name|default:'' }}">
                            </div>
                            {% if color_form.name.errors %}
                            <div class="text-danger small">{{ color_form.name.errors }}</div>
                            {% endif %}
                            {% if color_form.hex.errors %}
                            <div class="text-danger small">{{ color_form.hex.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Cost -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Cost Price (₹)</label>
                            <input name="cost" value="{{ form.cost.value|default:'' }}" type="number"
                                class="form-control">
                            {% if form.cost.errors %}
                            <div class="text-danger small">{{ form.cost.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Selling Price -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Selling Price (₹)</label>
                            <input name="price" type="number" value="{{ form.price.value|default:'' }}"
                                class="form-control">
                            {% if form.price.errors %}
                            <div class="text-danger small">{{ form.price.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Stock -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Stock</label>
                            <input name="stock" type="number" value="{{ form.stock.value|default:'' }}"
                                class="form-control">
                            {% if form.stock.errors %}
                            <div class="text-danger small">{{ form.stock.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Dimensions -->
                        <div class="col-12">
                            <label class="form-label small text-muted">Dimensions (cm)</label>
                            <div class="input-group">
                                <span class="input-group-text">H</span>
                                <input name="height" type="number" value="{{ form.height.value|default:'' }}"
                                    class="form-control">

                                <span class="input-group-text">W</span>
                                <input name="width" type="number" value="{{ form.width.value|default:'' }}"
                                    class="form-control">

                                <span class="input-group-text">D</span>
                                <input name="depth" type="number" value="{{ form.depth.value|default:'' }}"
                                    class="form-control">
                            </div>
                            {% if form.height.errors %}
                            <div class="text-danger small">{{ form.height.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Images -->
                        <div class="col-12">
                            <label class="form-label small text-muted">Variant Images</label>
                            <div class="d-flex gap-3 flex-wrap p-3 bg-light rounded">
                                <div class="variant-thumbnails" id="thumbs-variant-1"></div>

                                <label class="variant-img-upload-box btn btn-outline-secondary border-dashed">
                                    <!-- single file input; JS will allow adding multiple images via crop -->
                                    {% comment %} <input type="file" accept="image/*" hidden id="img-input-variant-1"
                                        class="img-input"> {% endcomment %}
                                        <input type="file"
       accept="image/*"
       hidden
       id="img-input-variant-1"
       onchange="initCrop(this)">

                                    <i class="fas fa-plus mb-1"></i>
                                    <small>Add</small>
                                </label>
                            </div>
                            <div class="form-text small">You can add up to {{ max_images|default:"10" }} images per
                                variant.
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-12 mt-4 d-flex justify-content-between">
                    {% if edit  %}
                    <div>
                        <!-- We only allow one variant at a time (Save to add another) -->
                        <a class="btn btn-secondary" href="{% url 'cadmin:interior_product_manage' %}">Cancel</a>
                        <button type="submit" class="btn btn-success px-4">Save Variant</button>
                        
                    </div>
                    {% else %}
                    <div>
                        <!-- We only allow one variant at a time (Save to add another) -->
                        <button type="submit" class="btn btn-success px-4">Save Variant</button>
                        <a class="btn btn-secondary" href="{% url 'cadmin:varients_finshed' %}">Finish</a>
                    </div>
                    {% endif %}
                </div>
            </form>
        </div>
    </main>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="cropImage" src="" alt="Image to crop">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" id="cropCancelBtn">Cancel</button>
                    <button class="btn btn-primary" id="cropBtn">Crop & Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>

function updateVariantInput(selectEl, variantKey) {
    const container = document.getElementById(`variant-value-container-${variantKey}`);
    if (!container) return;

    if (selectEl.value === 'Size') {
        container.innerHTML = `
            <label class="form-label small text-muted">Size Label</label>
            <input type="text"
                   name="variant_size_${variantKey}"
                   class="form-control mb-2"
                   value="${container.dataset.sizeLabel || ''}"
                   placeholder="Small">

            <label class="form-label small text-muted">Sort Order</label>
            <input type="number"
                   name="variant_size_order_${variantKey}"
                   class="form-control"
                   value="${container.dataset.sizeOrder || ''}"
                   placeholder="1">
        `;
    } else {
        container.innerHTML = `
            <label class="form-label small text-muted">Color Name & Code</label>
            <div class="input-group">
                <span class="input-group-text p-1">
                    <input type="color"
                           name="variant_color_code_${variantKey}"
                           class="form-control form-control-color border-0"
                           value="${container.dataset.colorHex || '#000000'}">
                </span>
                <input type="text"
                       name="variant_color_${variantKey}"
                       class="form-control"
                       value="${container.dataset.colorName || ''}"
                       placeholder="Red">
            </div>
        `;
    }
}

  /* =====================================================
           1) EXISTING VARIANT IMAGES (EDIT MODE)
        ===================================================== */
        const existingImagesData = [
            {% if exsiting_images %}
        {% for img in exsiting_images %}
        {
            id: "{{ img.id }}",
                src: "{{ img.image.url }}",
                    order: {{ img.display_order}},
            isThumbnail: {% if img.is_thumbnail %}true{% else %}false{% endif %},
            isExisting: true,
                file: null
        } {% if not forloop.last %}, {% endif %}
        {% endfor %}
        {% endif %}
];

        /* =====================================================
           2) SHARED STATE
        ===================================================== */
        let cropper = null;
        let uploadedImages = [...existingImagesData];
        let deletedIds = [];
        const maxImages = Number("{{ max_images|default:'10' }}");

        const cropModalEl = document.getElementById('cropModal');
        const cropModal = new bootstrap.Modal(cropModalEl);
        const cropImage = document.getElementById('cropImage');

        /* =====================================================
           3) INIT
        ===================================================== */
   document.addEventListener('DOMContentLoaded', () => {
    refreshGallery();

    const select = document.getElementById('variantTypeSelect');
    if (select) {
        updateVariantInput(select, 'variant-1');
    }
});



        /* =====================================================
           4) SIDEBAR (OPTIONAL)
        ===================================================== */
        function toggleSidebar() {
            document.getElementById('sidebar')?.classList.toggle('active');
        }

        /* =====================================================
           5) IMAGE CROPPER
        ===================================================== */
        function initCrop(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file.');
                input.value = '';
                return;
            }

            if (uploadedImages.length >= maxImages) {
                alert(`Maximum ${maxImages} images allowed`);
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = e => {
                cropImage.src = e.target.result;
                cropModal.show();

                if (cropper) cropper.destroy();

                cropModalEl.addEventListener('shown.bs.modal', () => {
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1
                    });
                }, { once: true });
            };

            reader.readAsDataURL(file);
            input.value = '';
        }

        /* =====================================================
           6) CROP & ADD IMAGE
        ===================================================== */
        document.getElementById('cropBtn').addEventListener('click', () => {
            if (!cropper) return;

            cropper.getCroppedCanvas({ width: 800, height: 800 })
                .toBlob(blob => {
                    const id = Date.now() + Math.random();
                    const file = new File([blob], `variant_${id}.jpg`, { type: 'image/jpeg' });

                    uploadedImages.push({
                        id,
                        src: URL.createObjectURL(file),
                        order: uploadedImages.length + 1,
                        isThumbnail: uploadedImages.length === 0,
                        isExisting: false,
                        file
                    });

                    cropModal.hide();
                    cropper.destroy();
                    cropper = null;

                    refreshGallery();
                }, 'image/jpeg', 0.9);
        });

        /* =====================================================
           7) RENDER GALLERY
        ===================================================== */
        function refreshGallery() {
            const container = document.getElementById('thumbs-variant-1');
            container.innerHTML = '';

            if (!uploadedImages.length) return;

            uploadedImages.sort((a, b) => a.order - b.order);

            uploadedImages.forEach(img => {
                const wrap = document.createElement('div');
                wrap.className = 'variant-img-wrapper text-center';

                if (img.isThumbnail) {
                    const badge = document.createElement('div');
                    badge.className = 'primary-badge';
                    badge.innerText = 'Primary';
                    wrap.appendChild(badge);
                }

                const imageEl = document.createElement('img');
                imageEl.src = img.src;
                imageEl.className = 'variant-thumb border rounded mb-1';

                const btns = document.createElement('div');
                btns.className = 'd-flex gap-1 justify-content-center';

                const primaryBtn = document.createElement('button');
                primaryBtn.type = 'button';
                primaryBtn.className = 'btn btn-sm btn-light';
                primaryBtn.innerHTML = '<i class="fas fa-image"></i>';
                primaryBtn.onclick = () => setPrimary(img.id);

                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-sm btn-danger';
                delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                delBtn.onclick = () => removeImage(img.id);

                btns.appendChild(primaryBtn);
                btns.appendChild(delBtn);

                wrap.appendChild(imageEl);
                wrap.appendChild(btns);
                container.appendChild(wrap);
            });
        }

        /* =====================================================
           8) IMAGE ACTIONS
        ===================================================== */
        function setPrimary(id) {
            uploadedImages.forEach(i => i.isThumbnail = (i.id === id));
            refreshGallery();
        }

        function removeImage(id) {
            const img = uploadedImages.find(i => i.id === id);
            if (!img) return;

            if (img.isExisting) deletedIds.push(img.id);

            if (!img.isExisting && img.src.startsWith('blob:')) {
                URL.revokeObjectURL(img.src);
            }

            uploadedImages = uploadedImages.filter(i => i.id !== id);

            if (uploadedImages.length && !uploadedImages.some(i => i.isThumbnail)) {
                uploadedImages[0].isThumbnail = true;
            }

            uploadedImages.forEach((i, idx) => i.order = idx + 1);
            refreshGallery();
        }

        /* =====================================================
           9) FORM SUBMIT (BACKEND COMPATIBLE)
        ===================================================== */
        document.getElementById('productForm').addEventListener('submit', function () {

            this.querySelectorAll('.dynamic-image-input').forEach(el => el.remove());

            uploadedImages.sort((a, b) => a.order - b.order);

            uploadedImages.forEach((img, idx) => {

                // image type (existing / new)
                addHidden(this, 'image_types', img.isExisting ? 'existing' : 'new');

                // existing image ids
                if (img.isExisting) {
                    addHidden(this, 'existing_images', img.id);
                }

                // new images
                if (!img.isExisting && img.file) {
                    const dt = new DataTransfer();
                    dt.items.add(img.file);

                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.name = 'images';
                    fileInput.files = dt.files;
                    fileInput.className = 'dynamic-image-input d-none';
                    this.appendChild(fileInput);
                }

                // order & primary
                addHidden(this, 'orders', idx + 1);
                addHidden(this, 'primary', img.isThumbnail ? '1' : '0');
            });

            // deleted images
            deletedIds.forEach(id => addHidden(this, 'deleted_ids', id));
        });

        /* =====================================================
           10) HELPER
        ===================================================== */
        function addHidden(form, name, value) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            input.classList.add('dynamic-image-input');
            form.appendChild(input);
        }
        
    </script>
    

</body>

</html>