{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Interior Product - Variants | Admin Dashboard</title>

    <!-- Fonts / CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Cropper -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        body {
            background: #f8f9fa;
            font-family: 'Outfit', sans-serif;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            padding-top: 48px;
            background: #fff;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .06);
        }

        .main-content {
            margin-left: 240px;
            padding: 2rem;
            transition: all .3s;
        }

        .form-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .05);
        }

        .img-container {
            max-height: 500px;
        }

        .img-container img {
            max-width: 100%;
            display: block;
        }

        .variant-thumb {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
            border-radius: 6px;
        }

        .variant-img-wrapper {
            width: 100px;
            position: relative;
            margin-bottom: 6px;
            margin-right: 8px;
        }

        .primary-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 123, 255, .9);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .order-input-container {
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: center;
            padding-top: 6px;
            margin-top: 6px;
        }

        .variant-thumbnails {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .variant-img-upload-box {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100px;
            height: 100px;
        }

        @media (max-width:768px) {
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .mobile-nav-toggle {
                display: block;
            }
        }
    </style>
</head>

<body>

    <button class="mobile-nav-toggle btn btn-light" onclick="toggleSidebar()"
        style="display:none; position:fixed; z-index:101; top:12px; left:12px;">
        <i class="fas fa-bars"></i>
    </button>

    <nav class="sidebar" id="sidebar">
        <div class="px-4 mb-4">
            <h3 class="fw-bold">HAM<span style="color:#d4af37">PR.</span></h3>
            <p class="text-muted small">Admin Portal</p>
        </div>
        <div class="px-3">
            <form action="{% url 'cadmin:cancel_add_product' %}" method="POST">
                {% csrf_token %}
                <button type="submit" href="" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-times me-2"></i>Cancel & Exit
                </button>
            </form>
        </div>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a style="text-decoration: none;" class="text-muted">Products</a></li>
                    <li class="breadcrumb-item"><a style="text-decoration: none;" class="text-muted">Interior Items</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Add Variants</li>
                </ol>
            </nav>

            <!-- <a href="admin-products-interior-add.html" class="text-decoration-none text-muted small">
                <i class="fas fa-arrow-left me-1"></i> Back to Step 1
            </a> -->
        </div>

        <h2 class="fw-bold">Add New Interior Product</h2>
        <p class="text-muted mb-4">Step 2: Inventory, Variants & Images</p>

        <div class="card form-card p-4">
            {% if messages %}
            <div class="mt-3">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <form id="productForm" action="" method="POST" enctype="multipart/form-data">
                {% if form.non_field_errors or color_form.non_field_errors or size_form.non_field_errors %}
                <div class="alert alert-danger">
                    <strong>There were some errors:</strong>
                    <ul class="mb-0">

                        <!-- Errors from main form -->
                        {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}

                        <!-- Errors from color form -->
                        {% for error in color_form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}

                        <!-- Errors from size form -->
                        {% for error in size_form.non_field_errors %}
                        <li>{{ error }}</li>
                        {% endfor %}

                    </ul>
                </div>
                {% endif %}
                {% csrf_token %}



                <!-- Single Product Container - ALWAYS HIDDEN -->
                <div id="singleProductContainer" class="col-12" style="display:none;"></div>

                <!-- VARIANTS SECTION ALWAYS VISIBLE -->
                <div id="variantsContainer" class="col-12">
                    <div id="variantsList" class="d-flex flex-column gap-3"></div>


                </div>

                <div class="col-12 mt-4 d-flex justify-content-between">
                    <!-- <a class="btn btn-secondary px-4" href="admin-products-interior-add.html">
                        <i class="fas fa-arrow-left me-2"></i> Back to Step 1
                    </a> -->
                    <div>
                        <button type="submit" class="btn btn-success px-4">Save Product</button>
                        <a class="btn btn-success" href="{%url 'cadmin:varients_finshed'%}">Finish</a>
                    </div>

                </div>
            </form>
        </div>
    </main>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="cropImage" src="" alt="Image to crop">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="cropBtn">Crop & Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        /* --------------------
         PAGE STATE
        -------------------- */
        let cropper = null;
        let currentCropInput = null;
        let currentVariantId = null;
        let variantImages = {};
        const maxImages = 10;

        document.addEventListener("DOMContentLoaded", () => {

            /* Restore Step 1 Data */
            const stored = localStorage.getItem('tempInteriorProduct');
            if (stored) {
                const data = JSON.parse(stored);
                hiddenName.value = data.name || '';
                hiddenBrand.value = data.brand || '';
                hiddenCategory.value = data.category || '';
                hiddenDescription.value = data.description || '';
                hiddenFeatured.value = data.featured || '';
                hiddenStatus.value = data.status || '';
            }

            // Always enable variant mode
            document.getElementById("variantsContainer").style.display = "block";
            document.getElementById("singleProductContainer").style.display = "none";

            // Auto add first variant
            if (document.getElementById("variantsList").children.length === 0) {
                addVariant();
            }
        });

        /* --------------------
         VARIANT UI GENERATION
        -------------------- */
        let variantCount = 0;

        function addVariant() {
            variantCount++;
            const id = `variant-${variantCount}`;

            const html = `
    <div class="variant-card card mb-3 p-3" id="${id}">
        

        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small text-muted">Type</label>
                <select name="variant_type_${id}" class="form-select" onchange="updateVariantInput(this,'${id}')">
                    <option value="Color">Color</option>
                    <option value="Size">Size</option>
                </select>
            </div>

            <div class="col-md-4" id="variant-value-container-${id}">
                <label class="form-label small text-muted">Color Name & Code</label>
                <div class="input-group">
                    <span class="input-group-text p-1">
                        <input name="variant_color_code_${id}" type="color" class="form-control form-control-color border-0" value="{{   color_form.hex.value}}">
                        {{color_form.hex.errors}}
                    </span>
                    <input name="variant_color_${id}" type="text" class="form-control" placeholder="e.g. Red" {% if color_form.name.value %} value="{{color_form.name.value}}{% endif    %}">
                    {{color_form.name.errors}}
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label small text-muted">Cost Price (₹)</label>
                <input name="cost" value={{form.cost.value}} type="number" class="form-control">
                {{form.cost.errors}}
            </div>

            <div class="col-md-6">
                <label class="form-label small text-muted">Selling Price (₹)</label>
                <input name="price" type="number" value={{form.price.value}} class="form-control">
                {{form.price.errors}}
            </div>
             <div class="col-md-6">
                <label class="form-label small text-muted">Stock</label>
                <input name="stock" type="number" value={{form.stock.value}} class="form-control">
                {{form.stock.errors}}
            </div>

            <div class="col-12">
                <label class="form-label small text-muted">Dimensions (cm)</label>
                <div class="input-group">
                    <span class="input-group-text">H</span>
                    <input name="height" type="number value={{form.height.value}}" class="form-control">
                    {{form.height.errors}}
                    <span class="input-group-text">W</span>
                    <input name="width" type="number" value={{form.width.value}} class="form-control">
                    {{form.width.errors}}
                    <span class="input-group-text">D</span>
                    <input name="depth" type="number" value={{form.depth.value}} class="form-control">
                    {{form.height.errors}}
                </div>
            </div>

            <div class="col-12">
                <label class="form-label small text-muted">Variant Images</label>
                <div class="d-flex gap-3 flex-wrap p-3 bg-light rounded">
                    <div class="variant-thumbnails" id="thumbs-${id}"></div>

                    <label class="variant-img-upload-box btn btn-outline-secondary border-dashed">
                        <input type="file" accept="image/*" hidden onchange="initCrop(this,'${id}')">
                        <i class="fas fa-plus mb-1"></i>
                        <small>Add</small>
                    </label>
                </div>
            </div>
        </div>
    </div>
    `;

            document.getElementById("variantsList").insertAdjacentHTML("beforeend", html);
            variantImages[id] = [];
        }

        function removeVariant(id) {
            delete variantImages[id];
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function updateVariantInput(select, id) {
            const target = document.getElementById(`variant-value-container-${id}`);
            if (select.value === "Color") {
                target.innerHTML = `
            <label class="form-label small text-muted">Color Name & Code</label>
            <div class="input-group">
                <span class="input-group-text p-1"><input type="color" name="variant_color_code_${id}" class="form-control form-control-color border-0"></span>
                <input type="text" name="variant_color_${id}" class="form-control" placeholder="Red">
            </div>
        `;
            } else {
                target.innerHTML = `
                <div>
            <label class="form-label small text-muted">Value</label>
            <input type="text" name="size" value="{% if size_form.name.value %} {{size_form.name.value}}{% endif %}" class="form-control" placeholder="Small">
             <label class="form-label small text-muted mt-3">Sort Order</label>
            <input type="text" name="sort_order " value="{{size_form.sort_order.value}}" class="form-control" placeholder="Small">
                </div>
        `;
            }
        }

        /* --------------------
        IMAGE CROP + PREVIEW
        -------------------- */
        const cropModalEl = document.getElementById("cropModal");
        const cropModal = new bootstrap.Modal(cropModalEl);
        const cropImage = document.getElementById("cropImage");

        function initCrop(input, variantId) {
            if (!input.files[0]) return;
            currentCropInput = input;
            currentVariantId = variantId;

            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = e => {
                cropImage.src = e.target.result;
                cropModal.show();

                cropModalEl.addEventListener(
                    "shown.bs.modal",
                    () => {
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(cropImage, {
                            aspectRatio: 1,
                            viewMode: 1,
                            autoCropArea: 1,
                        });
                    },
                    { once: true }
                );
            };
            reader.readAsDataURL(file);

            input.value = "";
        }

        document.getElementById("cropBtn").onclick = () => {
            if (!cropper) return;

            cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => {
                const id = Date.now();
                const file = new File([blob], `image_${id}.jpg`, { type: "image/jpeg" });
                const src = URL.createObjectURL(file);

                variantImages[currentVariantId].push({
                    id, file, src,
                    order: variantImages[currentVariantId].length + 1,
                    isThumbnail: variantImages[currentVariantId].length === 0
                });

                refreshVariantPreview(currentVariantId);
                cropModal.hide();
                cropper.destroy();
            });
        };

        function refreshVariantPreview(variantId) {
            const container = document.getElementById(`thumbs-${variantId}`);
            container.innerHTML = "";

            variantImages[variantId].forEach(img => {
                const wrap = document.createElement("div");
                wrap.className = "variant-img-wrapper";

                wrap.innerHTML = `
            ${img.isThumbnail ? `<div class="primary-badge">Primary</div>` : ""}
            <img src="${img.src}" class="variant-thumb border rounded mb-1">

            <div class="d-flex gap-1 justify-content-center">
                <button type="button" class="btn btn-sm btn-light" onclick="setPrimary('${variantId}',${img.id})">
                    <i class="fas fa-image"></i>
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="deleteImg('${variantId}',${img.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
                container.appendChild(wrap);
            });
        }

        function setPrimary(variantId, imgId) {
            variantImages[variantId].forEach(i => (i.isThumbnail = i.id === imgId));
            refreshVariantPreview(variantId);
        }

        function deleteImg(variantId, imgId) {
            variantImages[variantId] = variantImages[variantId].filter(i => i.id !== imgId);

            if (variantImages[variantId].length && !variantImages[variantId].some(i => i.isThumbnail)) {
                variantImages[variantId][0].isThumbnail = true;
            }

            refreshVariantPreview(variantId);
        }

        /* --------------------
         FORM SUBMIT
        -------------------- */
        document.getElementById("productForm").addEventListener("submit", function () {

            this.querySelectorAll(".dynamic-image-input").forEach(x => x.remove());

            Object.keys(variantImages).forEach(variantId => {
                variantImages[variantId].forEach((img, index) => {
                    const dt = new DataTransfer();
                    dt.items.add(img.file);

                    const f = document.createElement("input");
                    f.type = "file";
                    f.name = `images`;
                    f.files = dt.files;
                    f.className = "dynamic-image-input d-none";

                    const order = document.createElement("input");
                    order.type = "hidden";
                    order.name = `orders`;
                    order.value = index + 1;
                    order.className = "dynamic-image-input";

                    const primary = document.createElement("input");
                    primary.type = "hidden";
                    primary.name = `primary`;
                    primary.value = img.isThumbnail ? "1" : "0";
                    primary.className = "dynamic-image-input";

                    this.appendChild(f);
                    this.appendChild(order);
                    this.appendChild(primary);
                });
            });
        });

    </script>
</body>

</html>