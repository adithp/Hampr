

{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Interior Product - Simple | Admin Dashboard</title>

    <!-- Fonts / CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Cropper -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

    <style>
        /* Keep styling close to yours */
        body {
            background: #f8f9fa;
            font-family: 'Outfit', sans-serif;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            padding-top: 48px;
            background: #fff;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .06);
        }

        .main-content {
            margin-left: 240px;
            padding: 2rem;
            transition: all .3s;
        }

        .form-card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .05);
        }

        .img-container {
            max-height: 500px;
        }

        .img-container img {
            max-width: 100%;
            display: block;
        }

        .variant-thumb {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
            border-radius: 6px;
        }

        .variant-img-wrapper {
            width: 100px;
            position: relative;
            margin-bottom: 6px;
            margin-right: 8px;
        }

        .primary-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 123, 255, .9);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .order-input-container {
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            align-items: center;
            padding-top: 6px;
            margin-top: 6px;
        }

        .variant-thumbnails {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .variant-img-upload-box {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            width: 100px;
            height: 100px;
        }

        .btn-sm {
            padding: .25rem .5rem;
            font-size: .75rem;
        }

        @media (max-width:768px) {
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .mobile-nav-toggle {
                display: block;
            }

            /* Error message container */
            .errorlist {
                list-style: none;
                padding: 0;
                margin: 6px 0 0 0;
            }

            /* Individual error message */
            .errorlist li {
                background: #ffe6e6;
                border-left: 4px solid #e60000;
                padding: 8px 12px;
                border-radius: 4px;
                color: #b30000;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 6px;
                font-weight: 500;
            }

            /* Icon */
            .errorlist li::before {
                content: "‚ö†Ô∏è";
                font-size: 14px;
            }

            a {
                text-decoration: none;
            }

        }
    </style>
</head>

<body>

    <button class="mobile-nav-toggle btn btn-light" onclick="toggleSidebar()"
        style="display:none; position:fixed; z-index:101; top:12px; left:12px;">
        <i class="fas fa-bars"></i>
    </button>

    <nav class="sidebar" id="sidebar">
        <div class="px-4 mb-4">
            <h3 class="fw-bold">HAM<span style="color:#d4af37">PR.</span></h3>
            <p class="text-muted small">Admin Portal</p>
        </div>
        <div class="px-3">
            {% if edit %}
                <a type="submit" href="{% url 'cadmin:interior_product_manage' %}" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-times me-2"></i>Cancel & Exit
                </a>
            {% else %}
            <form action="{% url 'cadmin:cancel_add_product' %}" method="POST">
                {% csrf_token %}
                <button type="submit" href="" class="btn btn-outline-secondary w-100 btn-sm">
                    <i class="fas fa-times me-2"></i>Cancel & Exit
                </button>
            </form>
            {% endif %}

        </div>
    </nav>

    <main class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a class="text-muted" style="text-decoration: none;">Products</a></li>
                    <li class="breadcrumb-item"><a class="text-muted" style="text-decoration: none;">Interior Items</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">{% if edit %}Edit {% else %}Add {% endif %} Simple Product</li>
                </ol>
            </nav>
            <!-- <a href="admin-products-interior-variant-selection.html" class="text-decoration-none text-muted small">
                <i class="fas fa-arrow-left me-1"></i> Back to Selection
            </a> -->
        </div>

        <h2 class="fw-bold">{% if edit %}Edit {% else %}Add New  {% endif %} Interior Product</h2>
        <p class="text-muted mb-4">Step 2: Inventory & Images (No Variants)</p>
{% if messages %}
<div class="mb-3">
    {% for message in messages %}
        {% if message.tags == 'success' %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% elif message.tags == 'error' %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% elif message.tags == 'warning' %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% else %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endif %}
    {% endfor %}
</div>
{% endif %}

        <div class="card form-card p-4">
            <form id="productForm" action="" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                    <p>{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}
                <!-- <div id="step1DataContainer" class="d-none">
                    <input type="hidden" name="name" id="hiddenName">
                    <input type="hidden" name="brand" id="hiddenBrand">
                    <input type="hidden" name="category" id="hiddenCategory">
                    <input type="hidden" name="description" id="hiddenDescription">
                    <input type="hidden" name="featured" id="hiddenFeatured">
                    <input type="hidden" name="status" id="hiddenStatus">
                    <input type="hidden" name="has_variants" value="false">
                </div> -->

                <div class="row g-3">

                    <!-- Single (global) product container -->
                    <div id="singleProductContainer" class="col-12">
                        <div class="card bg-light border-0 p-3">
                            <h6 class="fw-bold mb-3">Product Details</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Cost Price (‚Çπ)</label>
                                    <input required type="number" class="form-control" name="cost" placeholder="0.00"
                                        value="{{form.cost.value}}">
                                    {{form.cost.errors}}
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Selling Price (‚Çπ)</label>
                                    <input required type="number" class="form-control" name="price" placeholder="0.00"
                                        value="{{form.price.value}}">
                                    {{form.price.errors}}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small text-muted">Stock</label>
                                    <input required type="number" class="form-control" name="stock" placeholder="0"
                                        value="{{form.stock.value}}">
                                    {{from.stock.errors}}
                                </div>

                                <div class="col-12">
                                    <label class="form-label small text-muted">Dimensions (cm)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">H</span>
                                        <input required type="number" class="form-control" name="height"
                                            placeholder="Height" value="{{form.height.value}}">
                                        {{from.height.errors}}
                                        <span class="input-group-text">W</span>
                                        <input required type="number" class="form-control" name="width"
                                            placeholder="Width" value="{{form.width.value}}">
                                        {{form.width.errors}}
                                        <span class="input-group-text">D</span>
                                        <input required type="number" class="form-control" name="depth"
                                            placeholder="Depth" value="{{form.depth.value}}">
                                        {{form.depth.errors}}
                                    </div>
                                </div>

                                <!-- Global gallery -->
                                <div class="col-12">
                                    <label class="form-label small text-muted">Product Images</label>
                                    <div class="d-flex align-items-start gap-3 flex-wrap p-3 bg-white rounded-3 border">
                                        <div id="single-thumbs" class="variant-thumbnails"></div>

                                        <label class="variant-img-upload-box btn btn-outline-secondary border-dashed">
                                            <input id="globalFileInput" type="file" accept="image/*" hidden
                                                onchange="initCrop(this,'single')">
                                            <i class="fas fa-plus mb-1"></i>
                                            <small>Add</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-4 d-flex justify-content-between">
                        <div>
                            <a class="btn btn-secondary px-4" href="{% url 'cadmin:interior_product_manage' %}">
                            <i class="fas fa-arrow-left me-2"></i> Back
                        </a>
                        <button type="submit" class="btn btn-success px-4">Add Product</button>
                        </div>
                         
                    </div>
                </div>
            </form>
        </div>
    </main>

    <!-- Crop Modal -->
    <div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Crop Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="img-container">
                        <img id="cropImage" src="" alt="Image to crop">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="cropBtn">Crop & Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
/* =====================================================
   1) EXISTING IMAGES FROM BACKEND (EDIT MODE)
===================================================== */
const existingImagesData = [
    {% if existing_images %}
    {% for img in existing_images %}
    {
        id: "{{ img.id }}",
        src: "{{ img.image.url }}",
        order: {{ img.display_order }},
        isThumbnail: {{ img.is_thumbnail|yesno:"true,false" }},
        isExisting: true,
        file: null
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
    {% endif %}
];

/* =====================================================
   2) SHARED STATE
===================================================== */
let cropper = null;
let uploadedImages = [...existingImagesData];
let deletedIds = [];
const maxImages = 10;

const cropModalEl = document.getElementById('cropModal');
const cropModal = new bootstrap.Modal(cropModalEl);
const cropImage = document.getElementById('cropImage');

/* =====================================================
   3) INIT
===================================================== */
document.addEventListener('DOMContentLoaded', () => {
    refreshGallery();
});

/* =====================================================
   4) SIDEBAR
===================================================== */
function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
}

/* =====================================================
   5) IMAGE CROPPER (UNCHANGED)
===================================================== */
function initCrop(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];

    if (!file.type.startsWith('image/')) {
        alert('Please upload an image file.');
        input.value = '';
        return;
    }

    if (uploadedImages.length >= maxImages) {
        alert('Max ' + maxImages + ' images allowed');
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        cropImage.src = e.target.result;
        cropModal.show();

        if (cropper) cropper.destroy();

        cropModalEl.addEventListener('shown.bs.modal', () => {
            cropper = new Cropper(cropImage, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 1
            });
        }, { once: true });
    };
    reader.readAsDataURL(file);
    input.value = '';
}

/* =====================================================
   6) CROP & SAVE
===================================================== */
document.getElementById('cropBtn').addEventListener('click', () => {
    if (!cropper) return;

    cropper.getCroppedCanvas({ width: 800, height: 800 }).toBlob(blob => {
        const id = Date.now() + Math.random();
        const file = new File([blob], `image_${id}.jpg`, { type: 'image/jpeg' });

        uploadedImages.push({
            id,
            src: URL.createObjectURL(file),
            order: uploadedImages.length + 1,
            isThumbnail: uploadedImages.length === 0,
            isExisting: false,
            file
        });

        cropModal.hide();
        cropper.destroy();
        cropper = null;

        refreshGallery();
    }, 'image/jpeg', 0.9);
});

/* =====================================================
   7) GALLERY RENDER
===================================================== */
function refreshGallery() {
    const container = document.getElementById('single-thumbs');
    container.innerHTML = '';

    if (!uploadedImages.length) return;

    uploadedImages.sort((a, b) => a.order - b.order);

    uploadedImages.forEach(img => {
        const wrap = document.createElement('div');
        wrap.className = 'variant-img-wrapper text-center';

        const imageEl = document.createElement('img');
        imageEl.src = img.src;
        imageEl.className = 'variant-thumb mb-1 rounded border';

        if (img.isThumbnail) {
            const badge = document.createElement('div');
            badge.className = 'primary-badge';
            badge.innerText = 'Primary';
            wrap.appendChild(badge);
        }

        const btns = document.createElement('div');
        btns.className = 'd-flex gap-1 justify-content-center mt-1';

        const setPrimary = document.createElement('button');
        setPrimary.type = 'button';
        setPrimary.className = 'btn btn-sm btn-light';
        setPrimary.innerHTML = '<i class="fas fa-image"></i>';
        setPrimary.onclick = () => setThumbnail(img.id);

        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'btn btn-sm btn-danger';
        del.innerHTML = '<i class="fas fa-trash"></i>';
        del.onclick = () => removeImage(img.id);

        btns.appendChild(setPrimary);
        btns.appendChild(del);

        const orderDiv = document.createElement('div');
        orderDiv.className = 'order-input-container';

        const small = document.createElement('small');
        small.className = 'text-muted fw-bold';
        small.innerText = 'Order:';

        const orderInput = document.createElement('input');
        orderInput.type = 'number';
        orderInput.className = 'form-control form-control-sm w-50 text-center';
        orderInput.min = 1;
        orderInput.max = maxImages;
        orderInput.value = img.order;
        orderInput.onchange = () => updateOrder(img.id, orderInput.value);

        orderDiv.appendChild(small);
        orderDiv.appendChild(orderInput);

        wrap.appendChild(imageEl);
        wrap.appendChild(btns);
        wrap.appendChild(orderDiv);

        container.appendChild(wrap);
    });
}

/* =====================================================
   8) IMAGE ACTIONS
===================================================== */
function setThumbnail(id) {
    uploadedImages.forEach(i => i.isThumbnail = (i.id === id));
    refreshGallery();
}

function updateOrder(id, value) {
    const img = uploadedImages.find(i => i.id === id);
    img.order = parseInt(value) || 1;

    uploadedImages.sort((a, b) => a.order - b.order);
    uploadedImages.forEach((i, idx) => i.order = idx + 1);

    refreshGallery();
}

function removeImage(id) {
    const img = uploadedImages.find(i => i.id === id);

    if (img.isExisting) deletedIds.push(img.id);

    if (!img.isExisting && img.src.startsWith('blob:')) {
        URL.revokeObjectURL(img.src);
    }

    uploadedImages = uploadedImages.filter(i => i.id !== id);

    if (uploadedImages.length && !uploadedImages.some(i => i.isThumbnail)) {
        uploadedImages[0].isThumbnail = true;
    }

    uploadedImages.forEach((i, idx) => i.order = idx + 1);
    refreshGallery();
}

/* =====================================================
   9) FORM SUBMIT (INCLUDES image_types LIST)
===================================================== */
document.getElementById('productForm').addEventListener('submit', function () {

    this.querySelectorAll('.dynamic-image-input').forEach(el => el.remove());

    uploadedImages.sort((a, b) => a.order - b.order);

    uploadedImages.forEach((img, idx) => {

        // üîπ image type list (existing / new)
        addHidden(this, 'image_types', img.isExisting ? 'existing' : 'new');

        // existing image ids
        if (img.isExisting) {
            addHidden(this, 'existing_ids', img.id);
        }

        // new images
        if (!img.isExisting && img.file) {
            const dt = new DataTransfer();
            dt.items.add(img.file);

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.name = 'images';
            fileInput.files = dt.files;
            fileInput.classList.add('dynamic-image-input', 'd-none');
            this.appendChild(fileInput);
        }

        // order + primary
        addHidden(this, 'orders', idx + 1);
        addHidden(this, 'primary', img.isThumbnail ? '1' : '0');
    });

    // deleted images
    deletedIds.forEach(id => addHidden(this, 'deleted_ids', id));
});

/* =====================================================
   10) HELPER
===================================================== */
function addHidden(form, name, value) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    input.classList.add('dynamic-image-input');
    form.appendChild(input);
}

/* =====================================================
   11) BFCache SAFETY
===================================================== */

</script>


</body>

</html>
