{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>
        {% if edit %}Edit Box Images{% else %}Add Box - Step 3{% endif %} | Admin Dashboard
    </title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Cropper -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'accounts/css/style.css' %}" />

    <style>
        body { background-color: #f8f9fa; }

        .sidebar {
            position: fixed;
            top: 0; bottom: 0; left: 0;
            width: 240px; padding: 48px 0 0;
            background: white;
            border-right: 1px solid #ddd;
        }

        .main-content { margin-left: 240px; padding: 2rem; }

        .upload-area {
            border: 2px dashed #0066cc;
            padding: 3rem; border-radius: 8px;
            background: #f8f9ff;
            text-align: center; cursor: pointer;
        }

        .upload-area:hover { background: #e6efff; }

        .image-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }

        .image-card img { width: 100%; height: 150px; object-fit: cover; }

        .image-overlay {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.55);
            opacity: 0;
            transition: .2s;
            gap: 10px;
        }

        .image-card:hover .image-overlay { opacity: 1; }

        .badge-thumb {
            position: absolute; top: 8px; left: 8px;
            background: #17a2b8; color: white;
            padding: 4px 8px; border-radius: 4px;
            font-size: .75rem; font-weight: bold;
        }

        .order-input-container {
            border-top: 1px solid #ddd; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .cropper-wrapper {
    width: 100%;
    height: 420px;          /* SAME height for all images */
    max-height: 420px;
    background: #f1f5f9;
    overflow: hidden;

    display: flex;
    align-items: center;
    justify-content: center;
}

.cropper-wrapper img {
    max-width: 100%;
    max-height: 100%;
}

    </style>
</head>

<body>

<!-- Mobile Toggle -->
<button class="btn btn-light d-md-none position-fixed m-3" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
    <div class="px-4 mb-4">
        <h3 class="fw-bold">HAM<span class="text-gold">PR.</span></h3>
        <p class="text-muted small">Admin Portal</p>
    </div>

    <div class="px-3">
        <div class="alert alert-light border">
            <small class="text-muted d-block mb-2">Current Task:</small>

            {% if edit %}
            <div class="fw-bold text-primary"><i class="fas fa-image me-2"></i>Editing Box Images</div>
            {% else %}
            <div class="fw-bold text-primary"><i class="fas fa-box me-2"></i>Adding New Box</div>
            {% endif %}
        </div>

        <hr>

        <a href="{% url 'cadmin:box_product_adding_cancel' %}" class="btn btn-outline-secondary w-100 btn-sm">
            <i class="fas fa-times me-2"></i>Cancel & Exit
        </a>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">

    <!-- Header -->
    <div class="mb-4">
        <h2 class="fw-bold mb-1">
            {% if edit %}Edit Product Images{% else %}Upload Product Images{% endif %}
        </h2>
        <p class="text-muted">
            {% if edit %}
            Modify, reorder or remove existing images
            {% else %}
            Step 3 of 3: Upload, Crop & Order
            {% endif %}
        </p>
    </div>

    <!-- Summary for Add Mode -->
    {% if not edit %}
    <div class="card p-3 mb-4">
        <h4 class="fw-bold" id="summaryBoxName">Loading...</h4>
        <span class="badge bg-light text-dark border" id="summaryCategory"></span>

        <div class="mt-3 bg-light p-2 rounded border">
            <small class="text-muted">Image Status</small>
            <div class="fw-bold" id="imageCount">0/10 images uploaded</div>
        </div>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <!-- FORM -->
    <form id="boxForm" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Upload Area -->
        <div class="upload-area mb-4" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-upload text-primary display-5 mb-3"></i>
            <h5>Click to Upload & Crop</h5>
            <p class="text-muted mb-0">JPG, PNG, WEBP Â· Max 5MB</p>
            <input type="file" id="fileInput" class="d-none" accept="image/*" onchange="handleFileSelect(this)">
        </div>

        <!-- Gallery -->
        <div class="row g-3 mb-5" id="imageGallery">
            <div class="col-12 text-center py-5 text-muted" id="emptyState">
                <i class="far fa-images fa-2x mb-2"></i>
                <p>No images uploaded yet.</p>
            </div>
        </div>

        <div id="dynamicInputsContainer"></div>

        <!-- Footer Buttons -->
        <div class="d-flex flex-column flex-md-row gap-2 border-top pt-4 w-25">

            <a href="{% url 'cadmin:box_manage' %}" class="btn btn-outline-secondary w-100">Cancel</a>

            <button type="submit" id="finishBtn" class="btn btn-success w-100">
                {% if edit %}Save Changes{% else %}Finish & Create Box{% endif %}
            </button>
        </div>
    </form>
</main>

<!-- Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="fw-bold">Crop Image</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"><div class="cropper-wrapper">
    <img id="imageToCrop" />
</div></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="cropAndSave()">Crop & Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
/* --------------------------------------
   1) INJECT EXISTING IMAGES FOR EDIT MODE
--------------------------------------- */
const editMode = {% if edit %}true{% else %}false{% endif %};

const existingImagesData = [
    {% if edit %}
    {% for img in existing_images %}
    {
        id: "{{ img.id }}",
        src: "{{ img.image.url }}",
        order: {{ img.display_order|default:"1" }},
        isThumbnail: {{ img.is_thumbnail|yesno:"true,false" }},
        isExisting: true,
        file: null
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
    {% endif %}
];

let uploadedImages = [...existingImagesData];
let deletedIds = [];
const maxImages = 10;

/* --------------------------------------
   2) INITIAL SETUP
--------------------------------------- */
window.addEventListener("DOMContentLoaded", () => {
    if (!editMode) {
        const saved = localStorage.getItem("newBoxData_Step1");
        if (saved) {
            const data = JSON.parse(saved);
            document.getElementById("summaryBoxName").textContent = data.name;
            document.getElementById("summaryCategory").textContent = data.category;
        }
    }
    refreshGallery();
});

/* --------------------------------------
   3) HANDLE SIDEBAR
--------------------------------------- */
function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("active");
}

/* --------------------------------------
   4) FILE SELECTION + CROPPER
--------------------------------------- */
let cropper;
const cropModalEl = document.getElementById("cropModal");
const cropModal = new bootstrap.Modal(cropModalEl);
const imageToCrop = document.getElementById("imageToCrop");

function handleFileSelect(input) {
    if (!input.files.length) return;

    const file = input.files[0];

    if (uploadedImages.length >= maxImages) {
        alert("Maximum " + maxImages + " images allowed.");
        return;
    }

    const reader = new FileReader();
    reader.onload = e => {
        imageToCrop.src = e.target.result;
        cropModal.show();
    };
    reader.readAsDataURL(file);

    input.value = "";
}
cropModalEl.addEventListener("shown.bs.modal", () => {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    cropper = new Cropper(imageToCrop, {
        aspectRatio: 1,
        viewMode: 1,
        dragMode: "move",
        autoCropArea: 0.7,
        responsive: true,
        background: false,
        zoomOnWheel: false,

        ready() {
            cropper.setCropBoxData({
                width: 280,
                height: 280,
            });
        }
    });
});

cropModalEl.addEventListener("hidden.bs.modal", () => {
    if (cropper) cropper.destroy();
});

/* --------------------------------------
   5) CROP & SAVE NEW IMAGE
--------------------------------------- */
function cropAndSave() {
    cropper.getCroppedCanvas({ width: 600, height: 600 })
        .toBlob(blob => {
            const id = Date.now() + Math.random();
            const file = new File([blob], `image_${id}.jpg`, { type: "image/jpeg" });

            uploadedImages.push({
                id,
                src: URL.createObjectURL(file),
                order: uploadedImages.length + 1,
                isThumbnail: uploadedImages.length === 0,
                isExisting: false,
                file
            });

            cropModal.hide();
            refreshGallery();
        });
}

/* --------------------------------------
   6) GALLERY RENDERING
--------------------------------------- */
function refreshGallery() {
    const gallery = document.getElementById("imageGallery");
    gallery.innerHTML = "";

    if (uploadedImages.length === 0) {
        gallery.innerHTML = `
        <div class="col-12 text-center py-5 text-muted" id="emptyState">
            <i class="far fa-images fa-2x mb-2"></i>
            <p>No images uploaded yet.</p>
        </div>`;
        return;
    }

    uploadedImages.sort((a,b)=>a.order - b.order);

    uploadedImages.forEach(img => {
        let col = document.createElement("div");
        col.className = "col-6 col-md-4 col-lg-3";
        col.innerHTML = `
            <div class="image-card position-relative">
                <img src="${img.src}">
                ${img.isThumbnail ? `<span class="badge-thumb">Thumbnail</span>` : ""}
                <div class="image-overlay">
                    <button class="btn btn-light btn-sm rounded-circle" onclick="setThumbnail('${img.id}')">
                        <i class="fas fa-image text-info"></i>
                    </button>
                    <button class="btn btn-light btn-sm rounded-circle text-danger" onclick="removeImage('${img.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="order-input-container">
                <small class="fw-bold text-muted">Order</small>
                <input type="number" class="form-control form-control-sm w-50"
                    min="1" max="${maxImages}" value="${img.order}"
                    onchange="updateOrder('${img.id}', this.value)">
            </div>
        `;
        gallery.appendChild(col);
    });
}

/* --------------------------------------
   7) ORDER CHANGE
--------------------------------------- */
function updateOrder(id, value) {
    let img = uploadedImages.find(i => i.id == id);
    img.order = parseInt(value) || 1;

    uploadedImages.sort((a,b)=>a.order - b.order);
    uploadedImages.forEach((i,idx)=> i.order = idx+1);

    refreshGallery();
}

/* --------------------------------------
   8) THUMBNAIL
--------------------------------------- */
function setThumbnail(id) {
    uploadedImages.forEach(i => i.isThumbnail = (i.id == id));
    refreshGallery();
}

/* --------------------------------------
   9) DELETE IMAGE
--------------------------------------- */
function removeImage(id) {
    const img = uploadedImages.find(i => i.id == id);

    if (img.isExisting) deletedIds.push(id);

    if (!img.isExisting && img.src.startsWith("blob:"))
        URL.revokeObjectURL(img.src);

    uploadedImages = uploadedImages.filter(i => i.id != id);
    uploadedImages.forEach((i, idx) => i.order = idx + 1);

    if (uploadedImages.length && !uploadedImages.some(i => i.isThumbnail))
        uploadedImages[0].isThumbnail = true;

    refreshGallery();
}

/* --------------------------------------
   10) SUBMIT HANDLER
--------------------------------------- */
document.getElementById("boxForm").addEventListener("submit", function () {
    const form = this;

    form.querySelectorAll(".dynamic-image-input").forEach(el => el.remove());

    uploadedImages.sort((a,b)=>a.order - b.order);

    uploadedImages.forEach(img => {

        // seq_types
        addHidden(form, "seq_types", img.isExisting ? "existing" : "new");

        // existing IDs
        if (img.isExisting) addHidden(form, "existing_ids", img.id);

        // new image upload
        if (!img.isExisting) {
            const dt = new DataTransfer();
            dt.items.add(img.file);

            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.name = "images";
            fileInput.files = dt.files;
            fileInput.classList.add("dynamic-image-input", "d-none");
            form.appendChild(fileInput);
        }

        addHidden(form, "orders", img.order);
        addHidden(form, "primary", img.isThumbnail ? "1" : "0");
    });

    // deleted IDs
    deletedIds.forEach(id => addHidden(form, "deleted_ids", id));
});

function addHidden(form, name, value) {
    let input = document.createElement("input");
    input.type = "hidden";
    input.name = name;
    input.value = value;
    input.classList.add("dynamic-image-input");
    form.appendChild(input);
}

/* --------------------------------------
   11) FIX BROWSER BACK-CACHE ISSUE
--------------------------------------- */
window.addEventListener("pageshow", function (event) {
    if (event.persisted) window.location.reload();
});
</script>

</body>
</html>
